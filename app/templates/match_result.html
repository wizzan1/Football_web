{% extends "base.html" %}
{% block title %}Match Results{% endblock %}
{% block content %}
<div class="card shadow-sm">
    <div class="card-header bg-dark text-white">
        <h1 class="h2 mb-0">Match Results</h1>
    </div>
    <div class="card-body">
        <div class="accordion" id="simAccordion">
            {% for result in results %}
            {% set idx = loop.index0 %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading{{ idx }}">
                    <button class="accordion-button {% if idx > 0 %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ idx }}" aria-expanded="{% if idx == 0 %}true{% else %}false{% endif %}" aria-controls="collapse{{ idx }}">
                        Sim {{ loop.index }}: {{ result.team_a_name }} (H) {{ result.score_a }} - {{ result.score_b }} {{ result.team_b_name }} (A)
                    </button>
                </h2>
                <div id="collapse{{ idx }}" class="accordion-collapse collapse {% if idx == 0 %}show{% endif %}" aria-labelledby="heading{{ idx }}" data-bs-parent="#simAccordion">
                    <div class="accordion-body">
                        <div id="match-log-{{ idx }}" class="match-timeline">
                            <!-- Log entries will be inserted here by JS -->
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<style>
    /* Styles for the live timeline visualization */
    .match-timeline {
        font-family: monospace;
        white-space: pre-wrap; /* Respects newlines in summaries */
        max-height: 500px;
        overflow-y: auto;
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
    }
    .log-entry {
        margin-bottom: 5px;
        padding: 4px 8px;
        display: flex;
        align-items: flex-start;
        /* Transition for smooth appearance */
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .log-entry.visible {
        opacity: 1;
        transform: translateY(0);
    }
    .log-minute {
        font-weight: bold;
        margin-right: 15px;
        color: #007bff; /* Blue for timestamp */
        white-space: nowrap;
        min-width: 40px;
    }
    /* Importance Styling */
    .importance-goal {
        color: #155724;
        background-color: #d4edda;
        border-left: 4px solid #28a745;
        font-weight: bold;
        animation: highlight-animation 1.5s ease;
    }
    .importance-save {
        color: #004085;
        background-color: #cce5ff;
        border-left: 4px solid #007bff;
        font-weight: bold;
    }
    .importance-miss {
        color: #721c24;
        background-color: #f8d7da;
    }
    .importance-info, .importance-error {
        background-color: #e9ecef;
        font-style: italic;
        padding: 10px;
        margin-bottom: 15px;
        border-left: 3px solid #6c757d;
    }
     .importance-error {
        background-color: #f8d7da;
        border-left-color: #dc3545;
        color: #721c24;
     }
    .importance-final {
        font-weight: bold;
        font-size: 1.2em;
        border-top: 2px solid #000;
        padding-top: 10px;
        margin-top: 15px;
        text-align: center;
    }

    @keyframes highlight-animation {
        0% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
</style>

<script>
    // The structure of logs is now: [[{'minute': 0, 'message': '...', 'importance': '...'}, ...], ...]
    const logs = {{ results | map(attribute='log') | list | tojson }};

    {% for result in results %}
    {% set idx = loop.index0 %}
    const logData{{ idx }} = logs[{{ idx }}] || [];
    const logDiv{{ idx }} = document.getElementById('match-log-{{ idx }}');
    let i{{ idx }} = 0;
    let isRunning{{ idx }} = false; // Flag to manage execution state

    function showNext{{ idx }}() {
        if (i{{ idx }} < logData{{ idx }}.length) {
            const entry = logData{{ idx }}[i{{ idx }}];
            const entryDiv = document.createElement('div');
            entryDiv.classList.add('log-entry');
            entryDiv.classList.add('importance-' + entry.importance);

            const messageSpan = document.createElement('span');
            messageSpan.textContent = entry.message;

            // Add minute visualization if applicable
            if (!['info', 'final', 'error'].includes(entry.importance) && entry.minute > 0) {
                const minuteSpan = document.createElement('span');
                minuteSpan.classList.add('log-minute');
                minuteSpan.textContent = `[${entry.minute}']`;
                entryDiv.appendChild(minuteSpan);
            }

            entryDiv.appendChild(messageSpan);
            logDiv{{ idx }}.appendChild(entryDiv);

            // Trigger the transition (CSS animation)
            setTimeout(() => entryDiv.classList.add('visible'), 10);

            // Auto-scroll
            logDiv{{ idx }}.scrollTop = logDiv{{ idx }}.scrollHeight;

            i{{ idx }}++;

            // Dynamic timeout for better pacing (much faster than the original 8000ms)
            let timeout = 500; // Fast pace for normal events (0.5s)
            if (entry.importance === 'goal') {
                timeout = 2500; // Long pause for goals (2.5s)
            } else if (entry.importance === 'info' or entry.importance === 'final') {
                timeout = 1000; // Pause for summaries (1s)
            } else if (entry.message.includes('opportunity') or entry.importance === 'save') {
                timeout = 1500; // Pause for critical moments (1.5s)
            }

            setTimeout(showNext{{ idx }}, timeout);
        }
    }

    // Logic to start the simulation display
    const collapseElement{{ idx }} = document.getElementById('collapse{{ idx }}');

    // Start the first one immediately if it's open
    {% if idx == 0 %}
        if (!isRunning{{ idx }}) {
            isRunning{{ idx }} = true;
            showNext{{ idx }}();
        }
    {% endif %}

    // Start others when their accordion tab is opened
    if (collapseElement{{ idx }}) {
        collapseElement{{ idx }}.addEventListener('shown.bs.collapse', function () {
            if (!isRunning{{ idx }}) {
                isRunning{{ idx }} = true;
                showNext{{ idx }}();
            }
        });
    }

    {% endfor %}
</script>
{% endblock %}