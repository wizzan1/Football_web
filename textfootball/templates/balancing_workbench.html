{% extends "base.html" %}
{% block title %}Simulation Sandbox & Balancing Workbench{% endblock %}
{% block content %}

<div class="card shadow-sm mb-4">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
        <h2 class="h4 mb-0">Morale System Tuning Workbench</h2>
        <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#moraleTuningCollapse" aria-expanded="false" aria-controls="moraleTuningCollapse">
            Toggle Panel
        </button>
    </div>
    <div class="collapse" id="moraleTuningCollapse">
        <div class="card-body">
            <p class="card-text">Adjust the core parameters of the morale system and analyze their theoretical impact. These changes are for analysis only and are not saved.</p>
            
            <div class="row">
                <div class="col-lg-6">
                    <form id="morale-params-form">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="MORALE_BASE_WIN" class="form-label">Base Win Impact</label>
                                <input type="number" class="form-control morale-param" id="MORALE_BASE_WIN" value="{{ default_morale_params.MORALE_BASE_WIN }}">
                            </div>
                            <div class="col-md-4">
                                <label for="MORALE_BASE_LOSS" class="form-label">Base Loss Impact</label>
                                <input type="number" class="form-control morale-param" id="MORALE_BASE_LOSS" value="{{ default_morale_params.MORALE_BASE_LOSS }}">
                            </div>
                             <div class="col-md-4">
                                <label for="MORALE_BASE_DRAW" class="form-label">Base Draw Impact</label>
                                <input type="number" class="form-control morale-param" id="MORALE_BASE_DRAW" value="{{ default_morale_params.MORALE_BASE_DRAW }}">
                            </div>

                            <div class="col-md-6">
                                <label for="MORALE_MARGIN_THRESHOLD" class="form-label">Margin Threshold (Goals)</label>
                                <input type="number" class="form-control morale-param" id="MORALE_MARGIN_THRESHOLD" value="{{ default_morale_params.MORALE_MARGIN_THRESHOLD }}">
                            </div>
                            <div class="col-md-6">
                                <label for="MORALE_MARGIN_MULTIPLIER" class="form-label">Margin Multiplier (e.g., 1.5)</label>
                                <input type="number" step="0.1" class="form-control morale-param" id="MORALE_MARGIN_MULTIPLIER" value="{{ default_morale_params.MORALE_MARGIN_MULTIPLIER }}">
                            </div>

                            <div class="col-md-6">
                                <label for="MORALE_GOAL_BONUS" class="form-label">Goal Bonus</label>
                                <input type="number" class="form-control morale-param" id="MORALE_GOAL_BONUS" value="{{ default_morale_params.MORALE_GOAL_BONUS }}">
                            </div>
                            <div class="col-md-6">
                                <label for="MORALE_HAT_TRICK_BONUS" class="form-label">Hat Trick Bonus</label>
                                <input type="number" class="form-control morale-param" id="MORALE_HAT_TRICK_BONUS" value="{{ default_morale_params.MORALE_HAT_TRICK_BONUS }}">
                            </div>

                            <div class="col-md-6">
                                <label for="MORALE_DRIFT_TARGET" class="form-label">Drift Target (0-100)</label>
                                <input type="number" class="form-control morale-param" id="MORALE_DRIFT_TARGET" value="{{ default_morale_params.MORALE_DRIFT_TARGET }}">
                            </div>
                            <div class="col-md-6">
                                <label for="MORALE_DRIFT_RATE" class="form-label">Drift Rate (e.g., 0.05)</label>
                                <input type="number" step="0.01" class="form-control morale-param" id="MORALE_DRIFT_RATE" value="{{ default_morale_params.MORALE_DRIFT_RATE }}">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="col-lg-6">
                    <div id="morale-analysis-results" class="alert alert-secondary">
                        <p>Adjust parameters to see analysis.</p>
                    </div>
                     <div id="morale-loader" class="d-none text-center">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Analyzing...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="card shadow-sm mb-4">
    <div class="card-header bg-dark text-white">
        <h1 class="h2 mb-0">Simulation Sandbox & Balancing Workbench</h1>
    </div>
    <div class="card-body">
        <p class="card-text">Adjust your team's stats in real-time and see the immediate impact on match outcome probabilities. Changes here are for simulation only and will not be saved.</p>
        {% if not user_team %}
        <div class="alert alert-warning" role="alert">
            You must have a team selected to use the workbench. Please go to your <a href="{{ url_for('game.dashboard') }}" class="alert-link">Dashboard</a>.
        </div>
        {% else %}
        <div class="row g-3">
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-header">
                        <strong>Your Team: {{ user_team.name }}</strong> (Full Squad)
                    </div>
                    <div class="card-body overflow-auto" style="max-height: 70vh;">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="show-only-starting" checked>
                            <label class="form-check-label small text-muted" for="show-only-starting">
                                Show only starting players (highlighted are the fixed starting 11 used in calculations.)
                            </label>
                        </div>
                        <form id="user-team-form">
                            <table class="table table-sm small" id="user-team-table">
                                <thead>
                                    <tr>
                                        <th>Player</th>
                                        <th>Pos</th>
                                        <th class="text-center">Skill</th>
                                        <th class="text-center">Shape</th>
                                        <th class="text-center">Morale</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for player in all_players %}
                                    <tr {% if player.id in starting_11_ids %}class="table-active starting-player"{% else %}class="bench-player"{% endif %}>
                                        <td>{{ player.name }}</td>
                                        <td><span class="badge bg-secondary">{{ player.position.name[0] }}</span></td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm player-stat-input"
                                                   data-player-id="{{ player.id }}" data-stat-type="skill"
                                                   value="{{ player.skill }}" min="1" max="100">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm player-stat-input"
                                                   data-player-id="{{ player.id }}" data-stat-type="shape"
                                                   value="{{ player.shape }}" min="1" max="100">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm player-stat-input"
                                                   data-player-id="{{ player.id }}" data-stat-type="morale"
                                                   value="{{ player.morale }}" min="0" max="100">
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3">
                 <div class="card h-100">
                     <div class="card-header">
                         <strong>Enemy Team</strong>
                     </div>
                     <div class="card-body">
                         <div class="mb-3">
                             <label for="enemy-team-select" class="form-label">Select Opponent:</label>
                             <select id="enemy-team-select" class="form-select">
                                 <option value="">-- Choose an Enemy --</option>
                                 {% for team in all_other_teams %}
                                 <option value="{{ team.id }}">{{ team.name }}</option>
                                 {% endfor %}
                             </select>
                         </div>
                         <div id="enemy-team-panel" class="overflow-auto" style="max-height: 60vh;">
                             <p class="text-muted text-center mt-4">Select an opponent to see their lineup.</p>
                         </div>
                     </div>
                 </div>
             </div>
             <div class="col-lg-5">
                 <div class="card h-100">
                     <div class="card-header d-flex justify-content-between align-items-center">
                         <strong>Analysis & Results</strong>
                     </div>
                     <div class="card-body" id="results-panel">
                         <p class="text-muted text-center mt-4">Adjust a stat or select an opponent to calculate odds.</p>
                         <div id="loader" class="d-none text-center">
                             <div class="spinner-border text-primary" role="status">
                                 <span class="visually-hidden">Loading...</span>
                             </div>
                             <p>Recalculating...</p>
                         </div>

                         <div id="batch-runner" class="border rounded p-2 mt-3">
                             <div class="d-flex align-items-end gap-2">
                                 <div class="flex-grow-1">
                                     <label for="batch-runs" class="form-label mb-1">Batch runs (X)</label>
                                     <input type="number" id="batch-runs" class="form-control" value="10" min="1" max="100">
                                 </div>
                                 <div>
                                     <button id="run-batch-btn" class="btn btn-primary">Run Batch</button>
                                 </div>
                             </div>
                             <div class="form-text">Each run uses the internal Monte Carlo in <code>get_prematch_odds</code> (default 100 sims).</div>
                             <div id="batch-loader" class="d-none text-center mt-2">
                                 <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                                 <p class="small mb-0">Running batch…</p>
                             </div>
                             <div id="batch-results" class="mt-3"></div>
                         </div>
                         </div>
                 </div>
             </div>
        </div>
        {% endif %}
    </div>
</div>

<template id="analysis-template">
    <ul class="nav nav-pills nav-fill nav-sm mb-2" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#pills-home" type="button" role="tab">Home Fixture</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pills-away-tab" data-bs-toggle="pill" data-bs-target="#pills-away" type="button" role="tab">Away Fixture</button>
        </li>
    </ul>
    <div class="tab-content">
        <div class="tab-pane fade show active p-2 border rounded" id="pills-home" role="tabpanel"></div>
        <div class="tab-pane fade p-2 border rounded" id="pills-away" role="tabpanel"></div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Element Selections ---
    const enemySelect = document.getElementById('enemy-team-select');
    const statInputs = document.querySelectorAll('.player-stat-input');
    const resultsPanel = document.getElementById('results-panel');
    const enemyPanel = document.getElementById('enemy-team-panel');
    const loader = document.getElementById('loader');
    const analysisTemplate = document.getElementById('analysis-template');
    const showOnlyStartingCheckbox = document.getElementById('show-only-starting');

    // Batch Runner elements
    const runBatchBtn = document.getElementById('run-batch-btn');
    const batchRunsInput = document.getElementById('batch-runs');
    const batchResults = document.getElementById('batch-results');
    const batchLoader = document.getElementById('batch-loader');

    // Morale Tuning elements
    const moraleParamInputs = document.querySelectorAll('.morale-param');
    const moraleAnalysisResults = document.getElementById('morale-analysis-results');
    const moraleLoader = document.getElementById('morale-loader');

    // Debounce timers for performance
    let debounceTimer;
    let moraleDebounceTimer;

    // --- Event Listeners ---
    function handleInputChange() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(updateWorkbench, 500);
    }

    function handleMoraleParamChange() {
        clearTimeout(moraleDebounceTimer);
        moraleDebounceTimer = setTimeout(analyzeMoraleSettings, 500);
    }

    if (enemySelect) {
        enemySelect.addEventListener('change', () => {
            updateWorkbench();
            analyzeMoraleSettings(); // Also trigger morale analysis when opponent changes
        });
    }
    
    statInputs.forEach(input => {
        input.addEventListener('input', handleInputChange);
    });
    
    moraleParamInputs.forEach(input => {
        input.addEventListener('input', handleMoraleParamChange);
    });

    if (runBatchBtn) {
        runBatchBtn.addEventListener('click', (e) => {
            e.preventDefault();
            runBatch();
        });
    }

    if (showOnlyStartingCheckbox) {
        showOnlyStartingCheckbox.addEventListener('change', function () {
            const benchRows = document.querySelectorAll('#user-team-table .bench-player');
            benchRows.forEach(row => {
                row.style.display = this.checked ? 'none' : '';
            });
        });
        showOnlyStartingCheckbox.dispatchEvent(new Event('change'));
    }

    // --- Data Collection Helper Functions ---
    function collectMoraleParams() {
        const params = {};
        moraleParamInputs.forEach(input => {
            const value = input.value;
            if (input.step && input.step.includes('.')) {
                params[input.id] = parseFloat(value) || 0;
            } else {
                params[input.id] = parseInt(value, 10) || 0;
            }
        });
        return params;
    }

    function collectUserTeamPlayers() {
        const userTeamPlayers = [];
        const playerIds = new Set();
        document.querySelectorAll('.player-stat-input[data-player-id]').forEach(input => {
            playerIds.add(input.dataset.playerId);
        });
        playerIds.forEach(id => {
            const skillInput = document.querySelector(`.player-stat-input[data-player-id='${id}'][data-stat-type='skill']`);
            const shapeInput = document.querySelector(`.player-stat-input[data-player-id='${id}'][data-stat-type='shape']`);
            const moraleInput = document.querySelector(`.player-stat-input[data-player-id='${id}'][data-stat-type='morale']`);
            
            userTeamPlayers.push({
                id: id,
                skill: skillInput ? (parseInt(skillInput.value, 10) || 50) : 50,
                shape: shapeInput ? (parseInt(shapeInput.value, 10) || 50) : 50,
                morale: moraleInput ? (parseInt(moraleInput.value, 10) || 80) : 80
            });
        });
        return userTeamPlayers;
    }

    // --- Backend API Call Functions ---
    async function analyzeMoraleSettings() {
        const enemyTeamId = enemySelect.value;
        if (!enemyTeamId) {
            moraleAnalysisResults.innerHTML = '<p class="text-muted">Select an opponent to run morale analysis.</p>';
            return;
        }
        
        moraleLoader.classList.remove('d-none');
        moraleAnalysisResults.innerHTML = '';

        const payload = {
            enemy_team_id: enemyTeamId,
            user_team_players: collectUserTeamPlayers(),
            morale_params: collectMoraleParams(),
            analysis_params: { start: 10, end: 100, step: 10 }
        };

        try {
            const response = await fetch("{{ url_for('game.analyze_morale_settings') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Server responded with an error');
            }

            const data = await response.json();
            renderMoraleAnalysis(data.analysis_results);

        } catch (error) {
            moraleAnalysisResults.innerHTML = `<div class="alert alert-danger p-2">${error.message}</div>`;
            console.error('Error analyzing morale settings:', error);
        } finally {
            moraleLoader.classList.add('d-none');
        }
    }
    
    async function updateWorkbench() {
        const enemyTeamId = enemySelect.value;
        if (!enemyTeamId) {
            resultsPanel.innerHTML = '<p class="text-muted text-center mt-4">Select an opponent to calculate odds.</p>';
            const batchRunner = document.getElementById('batch-runner');
            if(batchRunner) resultsPanel.appendChild(batchRunner);
            return;
        }

        const prevBatchRunner = document.getElementById('batch-runner');
        resultsPanel.innerHTML = '';
        if (prevBatchRunner) resultsPanel.appendChild(prevBatchRunner);
        
        loader.classList.remove('d-none');

        const payload = {
            enemy_team_id: enemyTeamId,
            user_team_players: collectUserTeamPlayers(),
            morale_params: collectMoraleParams()
        };

        try {
            const response = await fetch("{{ url_for('game.recalculate_odds') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Server responded with an error');
            }

            const data = await response.json();
            if (data.error) { throw new Error(data.error); }

            renderEnemyPanel(data.home_fixture.stats.enemy_team);
            renderResultsPanel(data);

        } catch (error) {
            resultsPanel.insertAdjacentHTML('afterbegin', `<div class="alert alert-danger">${error.message}</div>`);
            console.error('Error recalculating odds:', error);
        } finally {
            loader.classList.add('d-none');
        }
    }

    async function runBatch() {
        const enemyTeamId = enemySelect.value;
        if (!enemyTeamId) {
            batchResults.innerHTML = `<div class="alert alert-warning">Select an opponent first.</div>`;
            return;
        }
        const runs = Math.max(1, Math.min(parseInt(batchRunsInput.value || '10', 10), 100));
        
        const payload = {
            enemy_team_id: enemyTeamId,
            user_team_players: collectUserTeamPlayers(),
            runs: runs,
            morale_params: collectMoraleParams()
        };

        runBatchBtn.disabled = true;
        batchLoader.classList.remove('d-none');
        batchResults.innerHTML = '';

        try {
            const response = await fetch("{{ url_for('game.batch_odds') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Server responded with an error');
            }

            const data = await response.json();
            renderBatchResults(data);
            applyBatchMeansToMainBars(data);

        } catch (err) {
            console.error('Batch error:', err);
            batchResults.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
        } finally {
            runBatchBtn.disabled = false;
            batchLoader.classList.add('d-none');
        }
    }

    // --- Rendering Functions ---
    function renderMoraleAnalysis(results) {
        if (!results || results.length === 0) {
            moraleAnalysisResults.innerHTML = '<p class="text-muted">No analysis results to display.</p>';
            return;
        }
        let html = `<h6>Win/Draw/Loss % vs Team Morale (Home)</h6>
                    <div class="font-monospace small" style="line-height: 1.2;">`;
        results.forEach(point => {
            const morale = String(point.morale).padStart(3);
            const winProb = point.home_probs.win_prob;
            const drawProb = point.home_probs.draw_prob;
            const winBar = 'W'.repeat(Math.round(winProb / 2.5));
            const drawBar = 'D'.repeat(Math.round(drawProb / 2.5));
            html += `<div>${morale} | <span class="text-success">${winBar}</span><span class="text-warning">${drawBar}</span></div>`;
        });
        html += '</div>';
        moraleAnalysisResults.innerHTML = html;
    }
    
    function renderEnemyPanel(enemyTeamStats) {
        let html = `<table class="table table-sm small">
                        <thead><tr><th>Player</th><th>Pos</th><th class="text-center">Skill</th><th class="text-center">Shape</th><th class="text-center">Morale</th></tr></thead>
                        <tbody>`;
        enemyTeamStats.lineup.forEach(p => {
             html += `<tr>
                          <td>${p.name}</td>
                          <td><span class="badge bg-secondary">${p.position[0]}</span></td>
                          <td class="text-center">${p.skill}</td>
                          <td class="text-center">${p.shape}</td>
                          <td class="text-center">${p.morale}</td>
                      </tr>`;
        });
        html += '</tbody></table>';
        enemyPanel.innerHTML = html;
    }
    
    function renderResultsPanel(data) {
        const clone = analysisTemplate.content.cloneNode(true);
        const homePane = clone.querySelector('#pills-home');
        const awayPane = clone.querySelector('#pills-away');
        homePane.innerHTML = generateFixtureHtml(data.home_fixture, data.home_fixture.stats.user_team.name, data.home_fixture.stats.enemy_team.name, true);
        awayPane.innerHTML = generateFixtureHtml(data.away_fixture, data.away_fixture.stats.user_team.name, data.away_fixture.stats.enemy_team.name, false);
        const batchRunner = document.getElementById('batch-runner');
        resultsPanel.innerHTML = '';
        resultsPanel.appendChild(clone);
        if (batchRunner) {
            resultsPanel.appendChild(batchRunner);
        }
    }

    function generateFixtureHtml(fixtureData, userTeamName, enemyTeamName, isHomeFixture) {
        const userStats = fixtureData.stats.user_team;
        const enemyStats = fixtureData.stats.enemy_team;
        const probs = fixtureData.probs;
        let winProb, lossProb, drawProb, avgFor, avgAgainst, prefix;
        if (isHomeFixture) {
            prefix = 'home';
            winProb = probs.win_prob; drawProb = probs.draw_prob; lossProb = probs.loss_prob;
            avgFor = probs.avg_goals_for; avgAgainst = probs.avg_goals_against;
        } else {
            prefix = 'away';
            winProb = probs.loss_prob; drawProb = probs.draw_prob; lossProb = probs.win_prob;
            avgFor = probs.avg_goals_against; avgAgainst = probs.avg_goals_for;
        }
        const taleOfTheTape = `
            <table class="table table-sm table-bordered text-center small mb-2">
                <thead class="table-light">
                    <tr>
                        <th scope="col" style="width: 25%;">Metric</th>
                        <th scope="col" class="${userStats.is_home ? 'table-info' : ''}">${userStats.name} ${userStats.is_home ? '<span class="home-indicator">(H)</span>' : '<span class="away-indicator">(A)</span>'}</th>
                        <th scope="col" class="${enemyStats.is_home ? 'table-info' : ''}">${enemyStats.name} ${enemyStats.is_home ? '<span class="home-indicator">(H)</span>' : '<span class="away-indicator">(A)</span>'}</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><th>Avg. Base Skill</th><td>${userStats.avg_base_skill.toFixed(1)}</td><td>${enemyStats.avg_base_skill.toFixed(1)}</td></tr>
                    <tr><th>Avg. Team Shape</th><td>${userStats.avg_shape.toFixed(1)}%</td><td>${enemyStats.avg_shape.toFixed(1)}%</td></tr>
                    <tr><th>Avg. Team Morale</th><td>${userStats.avg_morale.toFixed(1)}</td><td>${enemyStats.avg_morale.toFixed(1)}</td></tr>
                    <tr class="fw-bold"><th>Avg. Effective Skill</th><td>${userStats.is_home ? `${userStats.base_avg_effective_skill.toFixed(1)} → <strong class="home-bonus">${userStats.avg_effective_skill.toFixed(1)}</strong> <small class="text-success">📈</small>` : userStats.avg_effective_skill.toFixed(1)}</td><td>${enemyStats.is_home ? `${enemyStats.base_avg_effective_skill.toFixed(1)} → <strong class="home-bonus">${enemyStats.avg_effective_skill.toFixed(1)}</strong> <small class="text-success">📈</small>` : enemyStats.avg_effective_skill.toFixed(1)}</td></tr>
                    ${['GOALKEEPER', 'DEFENDER', 'MIDFIELDER', 'FORWARD'].map(pos => `
                    <tr>
                        <th>${pos.substring(0,3)} Str</th>
                        <td>${userStats.is_home ? `${userStats.base_zonal_strength[pos].toFixed(1)} → <strong class="home-bonus">${userStats.zonal_strength[pos].toFixed(1)}</strong> <small class="text-success">📈</small>` : userStats.zonal_strength[pos].toFixed(1)}</td>
                        <td>${enemyStats.is_home ? `${enemyStats.base_zonal_strength[pos].toFixed(1)} → <strong class="home-bonus">${enemyStats.zonal_strength[pos].toFixed(1)}</strong> <small class="text-success">📈</small>` : enemyStats.zonal_strength[pos].toFixed(1)}</td>
                    </tr>
                    `).join('')}
                </tbody>
            </table>`;
        const progressBar = `
            <div class="progress" style="height: 20px; font-size: 0.75rem; font-weight: bold;">
                <div class="progress-bar bg-success" id="bar-${prefix}-win" style="width: ${winProb}%"><span>${winProb.toFixed(1)}%</span></div>
                <div class="progress-bar bg-warning text-dark" id="bar-${prefix}-draw" style="width: ${drawProb}%"><span>${drawProb.toFixed(1)}%</span></div>
                <div class="progress-bar bg-danger" id="bar-${prefix}-loss" style="width: ${lossProb}%"><span>${lossProb.toFixed(1)}%</span></div>
            </div>
            <div class="d-flex justify-content-between small mt-1">
                <span class="text-success">■ ${userTeamName} Win</span>
                <span class="text-warning">■ Draw</span>
                <span class="text-danger">■ ${enemyTeamName} Win</span>
            </div>
            <p class="small mt-2 text-center mb-0">Avg Goals: 
                <strong id="avg-${prefix}-for">${avgFor.toFixed(2)}</strong> - <strong id="avg-${prefix}-against">${avgAgainst.toFixed(2)}</strong>
            </p>`;
        return taleOfTheTape + progressBar;
    }

    function renderBatchResults(data) {
        const fmt = (v, digits = 2) => (typeof v === 'number' ? v.toFixed(digits) : '-');
        const hasNew = !!data.user && !!data.enemy;
        const userBlock = hasNew ? data.user : { home: data.home, away: data.away };
        const enemyBlock = hasNew ? data.enemy : flipPerspectiveFromUser(userBlock);
        const userName = data.user_team_name || 'Your Team';
        const enemyName = data.enemy_team_name || 'Enemy';

        const block = (title, stats) => `
            <div class="col-12 col-md-6">
                <div class="card border-0">
                    <div class="card-header bg-light"><strong>${title}</strong></div>
                    <div class="card-body p-2">
                        <table class="table table-sm small mb-0">
                            <thead><tr><th>Metric</th><th>Mean</th><th>Std Dev</th></tr></thead>
                            <tbody>
                                <tr><td>Win %</td><td>${fmt(stats.means.win_prob, 2)}</td><td>${fmt(stats.stddevs.win_prob, 2)}</td></tr>
                                <tr><td>Draw %</td><td>${fmt(stats.means.draw_prob, 2)}</td><td>${fmt(stats.stddevs.draw_prob, 2)}</td></tr>
                                <tr><td>Loss %</td><td>${fmt(stats.means.loss_prob, 2)}</td><td>${fmt(stats.stddevs.loss_prob, 2)}</td></tr>
                                <tr><td>Avg Goals For</td><td>${fmt(stats.means.avg_goals_for, 3)}</td><td>${fmt(stats.stddevs.avg_goals_for, 3)}</td></tr>
                                <tr><td>Avg Goals Against</td><td>${fmt(stats.means.avg_goals_against, 3)}</td><td>${fmt(stats.stddevs.avg_goals_against, 3)}</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;

        const header = `
            <div class="mb-2">
                <span class="badge bg-primary me-2">Runs: ${data.runs ?? '-'}</span>
                <span class="badge bg-secondary">Sims / run: ${data.simulations_per_run ?? 100}</span>
            </div>`;

        const userSection = `
            <div class="card mb-2">
                <div class="card-header"><strong>${userName} (Your Perspective)</strong></div>
                <div class="card-body p-2"><div class="row g-2">
                    ${block('Home Fixture', userBlock.home)}
                    ${block('Away Fixture', userBlock.away)}
                </div></div>
            </div>`;

        const enemySection = `
            <div class="card">
                <div class="card-header"><strong>${enemyName} (Enemy Perspective)</strong></div>
                <div class="card-body p-2"><div class="row g-2">
                    ${block('Home Fixture', enemyBlock.home)}
                    ${block('Away Fixture', enemyBlock.away)}
                </div></div>
            </div>`;

        batchResults.innerHTML = header + userSection + enemySection;
    }

    function flipPerspectiveFromUser(userBlock) {
        const flip = (stats) => {
            const m = stats.means || {};
            const s = stats.stddevs || {};
            const means = {
                win_prob: Number(m.loss_prob ?? 0), draw_prob: Number(m.draw_prob ?? 0), loss_prob: Number(m.win_prob ?? 0),
                avg_goals_for: Number(m.avg_goals_against ?? 0), avg_goals_against: Number(m.avg_goals_for ?? 0)
            };
            const stddevs = {
                win_prob: Number(s.loss_prob ?? 0), draw_prob: Number(s.draw_prob ?? 0), loss_prob: Number(s.win_prob ?? 0),
                avg_goals_for: Number(s.avg_goals_against ?? 0), avg_goals_against: Number(s.avg_goals_for ?? 0)
            };
            return { means, stddevs };
        };
        return { home: flip(userBlock.away), away: flip(userBlock.home) };
    }

    function applyBatchMeansToMainBars(data) {
        const hasNew = !!data.user && !!data.enemy;
        const userBlock = hasNew ? data.user : { home: data.home, away: data.away };
        if (userBlock?.home?.means) setBarsFromMeans('home', userBlock.home.means);
        if (userBlock?.away?.means) setBarsFromMeans('away', userBlock.away.means);
    }

    function setBarsFromMeans(prefix, means) {
        const winEl = document.getElementById(`bar-${prefix}-win`);
        const drawEl = document.getElementById(`bar-${prefix}-draw`);
        const lossEl = document.getElementById(`bar-${prefix}-loss`);
        const gfEl = document.getElementById(`avg-${prefix}-for`);
        const gaEl = document.getElementById(`avg-${prefix}-against`);
        if (!winEl || !drawEl || !lossEl || !gfEl || !gaEl) return;
        const win = Number(means.win_prob || 0);
        const draw = Number(means.draw_prob || 0);
        const loss = Number(means.loss_prob || 0);
        winEl.style.width = `${win}%`;
        drawEl.style.width = `${draw}%`;
        lossEl.style.width = `${loss}%`;
        const setBarLabel = (el, val) => {
            const span = el.querySelector('span') || document.createElement('span');
            span.textContent = `${val.toFixed(1)}%`;
            if (!el.contains(span)) el.appendChild(span);
        };
        setBarLabel(winEl, win);
        setBarLabel(drawEl, draw);
        setBarLabel(lossEl, loss);
        if (typeof means.avg_goals_for === 'number') gfEl.textContent = means.avg_goals_for.toFixed(2);
        if (typeof means.avg_goals_against === 'number') gaEl.textContent = means.avg_goals_against.toFixed(2);
    }
    
    // Initial call to populate the morale analysis panel on page load
    analyzeMoraleSettings();
});
</script>

<style>
    /* Home/Away Indicator Styling */
    .home-indicator {
        background-color: #28a745;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.8rem;
        font-weight: bold;
        margin-left: 5px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    
    .away-indicator {
        background-color: #dc3545;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.8rem;
        font-weight: bold;
        margin-left: 5px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    
    .home-bonus {
        color: #28a745;
        text-decoration: underline;
    }
</style>
{% endblock %}