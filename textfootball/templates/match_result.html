{% extends "base.html" %}
{% block title %}Match Results{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header bg-dark text-white">
        <h1 class="h2 mb-0">Match Results</h1>
    </div>
    <div class="card-body">
        <div class="accordion" id="simAccordion">
            {% for result in results %}
            {% set idx = loop.index0 %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading{{ idx }}">
                    <button class="accordion-button {% if idx > 0 %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ idx }}" aria-expanded="{% if idx == 0 %}true{% else %}false{% endif %}" aria-controls="collapse{{ idx }}">
                        Sim {{ loop.index }}:
                        <span style="color: {{ result.team_a_color }}; font-weight: bold; margin-left: 10px;">{{ result.team_a_name }} <span class="home-indicator">(H)</span> {{ result.score_a }}</span>
                        <span style="margin: 0 5px;"> - </span>
                        <span style="color: {{ result.team_b_color }}; font-weight: bold;">{{ result.score_b }} {{ result.team_b_name }} <span class="away-indicator">(A)</span></span>
                        {% if result.winner_on_penalties %}
                            <span class="badge bg-secondary ms-2">({{ result.shootout_score_a }} - {{ result.shootout_score_b }} pens)</span>
                        {% endif %}
                    </button>
                </h2>
                <div id="collapse{{ idx }}" class="accordion-collapse collapse {% if idx == 0 %}show{% endif %}" aria-labelledby="heading{{ idx }}" data-bs-parent="#simAccordion">
                    <div class="accordion-body">

                        <div class="dominance-bar-container mb-3">
                            <div class="d-flex justify-content-between small mb-1">
                                <span style="color: {{ result.team_a_color }};">{{ result.team_a_name }}</span>
                                <strong>Match Dominance</strong>
                                <span style="color: {{ result.team_b_color }};">{{ result.team_b_name }}</span>
                            </div>
                            <div class="dominance-bar" id="dominance-bar-{{ idx }}" style="background: linear-gradient(to right, {{ result.team_a_color }}, {{ result.team_b_color }});">
                                <div class="dominance-indicator" id="dominance-indicator-{{ idx }}"></div>
                            </div>
                        </div>

                        <div id="match-log-{{ idx }}" class="match-timeline">
                            </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<style>
    /* Dominance Bar Styling */
    .dominance-bar {
        height: 15px;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
        border: 1px solid #dee2e6;
    }
    .dominance-indicator {
        width: 4px;
        height: 100%;
        background-color: #343a40;
        position: absolute;
        left: 50%; /* Start centered */
        transform: translateX(-50%);
        transition: left 0.5s ease-in-out;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        animation: indicator-pulse 1.5s infinite;
    }
    @keyframes indicator-pulse {
        0% { box-shadow: 0 0 5px rgba(0, 0, 0, 0.5); }
        50% { box-shadow: 0 0 10px rgba(0, 0, 0, 0.8); }
        100% { box-shadow: 0 0 5px rgba(0, 0, 0, 0.5); }
    }

    /* Styles for the live timeline visualization */
    .match-timeline {
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 500px;
        overflow-y: auto;
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
    }
    .log-entry {
        margin-bottom: 8px;
        padding: 4px 8px;
        display: flex;
        align-items: flex-start;
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.3s ease, transform 0.3s ease;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .log-entry.visible {
        opacity: 1;
        transform: translateY(0);
    }
    .log-minute {
        font-weight: bold;
        margin-right: 15px;
        color: #0d6efd;
        white-space: nowrap;
        min-width: 40px;
    }
    .log-content {
        flex-grow: 1;
    }
    .log-details {
        font-size: 0.85em;
        color: #6c757d;
        margin-top: 5px;
        padding-left: 10px;
        border-left: 2px solid #dee2e6;
        font-style: italic;
        white-space: pre-wrap;
        line-height: 1.4;
    }
    .log-metadata {
        font-size: 0.9em;
        color: #495057;
        margin-left: 10px;
        font-style: italic;
    }
    .importance-pre_shot {
        background: linear-gradient(135deg, #fff3cd, #ffe69c);
        border-left: 4px solid #ffc107;
        animation: pulse-animation 1s infinite alternate;
    }
    @keyframes pulse-animation {
        from { opacity: 1; }
        to { opacity: 0.7; }
    }
    .importance-goal {
        color: #155724;
        background-color: #d4edda;
        border-left: 4px solid #28a745;
        font-weight: bold;
        animation: highlight-animation 1.5s ease;
    }
    .importance-save {
        color: #0c5460;
        background-color: #d1ecf1;
        border-left: 4px solid #17a2b8;
        font-weight: bold;
        animation: highlight-animation 1.5s ease;
    }
    .importance-miss {
        color: #721c24;
        background-color: #f8d7da;
    }
    .importance-info, .importance-error, .importance-final, .importance-set_piece {
        background-color: #e9ecef;
        font-style: italic;
        padding: 10px;
        margin-bottom: 15px;
        border-left: 3px solid #6c757d;
    }
     .importance-error {
        background-color: #f8d7da;
        border-left-color: #dc3545;
        color: #721c24;
    }
    .importance-final {
        font-weight: bold;
        font-size: 1.2em;
        border-top: 2px solid #000;
        padding-top: 10px;
        margin-top: 15px;
        text-align: center;
    }
    @keyframes highlight-animation {
        0% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    /* Home/Away Indicator Styling */
    .home-indicator {
        background-color: #28a745;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.8rem;
        font-weight: bold;
        margin-left: 5px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    
    .away-indicator {
        background-color: #dc3545;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.8rem;
        font-weight: bold;
        margin-left: 5px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
</style>

<script>
    const logs = {{ results | map(attribute='log') | list | tojson }};

    {% for result in results %}
    {% set idx = loop.index0 %}
    const logData{{ idx }} = logs[{{ idx }}] || [];
    const logDiv{{ idx }} = document.getElementById('match-log-{{ idx }}');
    const dominanceIndicator{{ idx }} = document.getElementById('dominance-indicator-{{ idx }}');
    let i{{ idx }} = 0;
    let isRunning{{ idx }} = false;

    function showNext{{ idx }}() {
        if (i{{ idx }} < logData{{ idx }}.length) {
            const entry = logData{{ idx }}[i{{ idx }}];
            const entryDiv = document.createElement('div');
            entryDiv.classList.add('log-entry');
            entryDiv.classList.add('importance-' + entry.importance);

            if (!['info', 'final', 'error'].includes(entry.importance) && entry.minute > 0) {
                const minuteSpan = document.createElement('span');
                minuteSpan.classList.add('log-minute');
                minuteSpan.textContent = `[${entry.minute}']`;
                entryDiv.appendChild(minuteSpan);
            }

            const contentDiv = document.createElement('div');
            contentDiv.classList.add('log-content');

            const messageSpan = document.createElement('span');
            // Use .innerHTML to render HTML tags from the log message
            messageSpan.innerHTML = entry.message;
            contentDiv.appendChild(messageSpan);

            // Display pre-shot metadata
            if (entry.metadata && (entry.metadata.distance || entry.metadata.danger_level)) {
                const metadataSpan = document.createElement('span');
                metadataSpan.classList.add('log-metadata');
                let metaText = '(';
                if (entry.metadata.distance) metaText += entry.metadata.distance;
                if (entry.metadata.danger_level) {
                    if (entry.metadata.distance) metaText += ', ';
                    metaText += 'Danger: ' + entry.metadata.danger_level;
                }
                metaText += ')';
                metadataSpan.textContent = metaText;
                contentDiv.appendChild(metadataSpan);
            }

            // Display log details
            if (entry.details && entry.details.trim() !== '') {
                const detailsDiv = document.createElement('div');
                detailsDiv.classList.add('log-details');
                detailsDiv.textContent = entry.details;
                contentDiv.appendChild(detailsDiv);
            }

            entryDiv.appendChild(contentDiv);
            logDiv{{ idx }}.appendChild(entryDiv);

            // Update Dominance Bar
            if (entry.metadata && entry.metadata.dominance !== undefined && dominanceIndicator{{ idx }}) {
                // Dominance score is -1 (A) to 1 (B). Map to 0% to 100%.
                const position = (entry.metadata.dominance + 1) * 50;
                dominanceIndicator{{ idx }}.style.left = `${position}%`;
            }

            // Animate entry visibility
            setTimeout(() => entryDiv.classList.add('visible'), 10);
            logDiv{{ idx }}.scrollTop = logDiv{{ idx }}.scrollHeight;
            i{{ idx }}++;

            // Set timeout for the next entry based on importance
            let timeout = 500;
            if (entry.importance === 'goal' || entry.importance === 'save') timeout = 2500;
            else if (entry.importance === 'info' || entry.importance === 'final') timeout = 1000;
            else if (entry.importance === 'pre_shot') timeout = 3000;

            setTimeout(showNext{{ idx }}, timeout);
        }
    }

    // Automatically start the simulation display for this accordion item.
    if (!isRunning{{ idx }}) {
        isRunning{{ idx }} = true;
        // Stagger the start of each simulation slightly
        setTimeout(() => showNext{{ idx }}(), {{ idx }} * 100);
    }
    {% endfor %}
</script>
{% endblock %}